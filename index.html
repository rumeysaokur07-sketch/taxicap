<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>TaxiCap</title>

<style>
  body { margin:0; font-family: Arial, sans-serif; }
  #map { height: 70vh; width: 100%; }
  #info { padding:10px; background:#f2f2f2; }
  #directions {
    max-height:200px;
    overflow-y:auto;
    padding:10px;
    background:#fff;
    border-top:1px solid #ccc;
  }
</style>
</head>

<body>

<div id="map"></div>

<div id="info">
  <p><b>TaxiCap Mesafe:</b> <span id="roadDistance">-</span></p>
  <p><b>Kuş Uçuşu Mesafe:</b> <span id="airDistance">-</span></p>
  <p><b>SPACE:</b> Taxi ileri sür</p>
</div>

<div id="directions"></div>

<script>
let map;
let points = [];
let markers = [];
let directionsService;
let directionsRenderer;
let airLine;
let taxiMarker;

let routePath = [];
let taxiIndex = 0;

function initMap() {
  map = new google.maps.Map(document.getElementById("map"), {
    center: { lat: 39.92, lng: 32.85 },
    zoom: 6,
    gestureHandling: "greedy"
  });

  directionsService = new google.maps.DirectionsService();
  directionsRenderer = new google.maps.DirectionsRenderer({
    suppressMarkers: true
  });
  directionsRenderer.setMap(map);

  map.addListener("click", (e) => {
    if (points.length === 2) resetAll();

    points.push(e.latLng);

    const marker = new google.maps.Marker({
      position: e.latLng,
      map: map
    });
    markers.push(marker);

    if (points.length === 2) {
      drawRoute();
      drawAirLine();
    }
  });

  window.addEventListener("keydown", (e) => {
    if (e.code === "Space") {
      e.preventDefault();
      moveTaxi();
    }
  });
}

function resetAll() {
  points = [];
  routePath = [];
  taxiIndex = 0;

  markers.forEach(m => m.setMap(null));
  markers = [];

  if (airLine) airLine.setMap(null);
  if (taxiMarker) taxiMarker.setMap(null);

  directionsRenderer.set("directions", null);
  document.getElementById("directions").innerHTML = "";
  document.getElementById("roadDistance").innerText = "-";
  document.getElementById("airDistance").innerText = "-";
}

function drawRoute() {
  directionsService.route({
    origin: points[0],
    destination: points[1],
    travelMode: "DRIVING"
  }, (result, status) => {
    if (status === "OK") {
      directionsRenderer.setDirections(result);

      const leg = result.routes[0].legs[0];
      document.getElementById("roadDistance").innerText = leg.distance.text;

      showDirections(leg.steps);
      routePath = result.routes[0].overview_path;
      placeTaxi(routePath[0]);
    }
  });
}

function moveTaxi() {
  if (!taxiMarker || taxiIndex >= routePath.length - 1) return;
  taxiIndex++;
  taxiMarker.setPosition(routePath[taxiIndex]);
}

function placeTaxi(position) {
  taxiMarker = new google.maps.Marker({
    position,
    map,
    icon: {
      url: "https://cdn-icons-png.flaticon.com/512/743/743007.png",
      scaledSize: new google.maps.Size(40, 40)
    }
  });
}

function drawAirLine() {
  const distance =
    google.maps.geometry.spherical.computeDistanceBetween(
      points[0], points[1]
    ) / 1000;

  document.getElementById("airDistance").innerText =
    distance.toFixed(2) + " km";

  airLine = new google.maps.Polyline({
    path: points,
    geodesic: true,
    strokeColor: "#ff00aa",
    strokeOpacity: 1,
    strokeWeight: 2,
    map
  });
}

function showDirections(steps) {
  const div = document.getElementById("directions");
  div.innerHTML = "<h3>Yol Tarifi</h3>";
  steps.forEach((s, i) => {
    div.innerHTML += `<p>${i+1}. ${s.instructions} (${s.distance.text})</p>`;
  });
}
</script>

<script
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBWoyRoh93RJfM7V3PLWzzckfH9yUBqU0c&libraries=geometry&callback=initMap"
  async defer>
</script>

</body>
</html>
